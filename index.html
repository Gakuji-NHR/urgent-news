<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1080, height=70, initial-scale=1" />
  <title>HANAZONO Updates Ticker</title>

  <style>
    :root{
      --band-bg: #000;
      --text-color: #fff;
      --label-bg: #c40000;
      --label-color: #fff;

      /* fixed 1080 x 70 */
      --label-font: 13px;
      --text-font: 17px;

      --label-pad-x: 12px;

      /* spacing */
      --label-row-gap: 4px;   /* ← ラベル内 EN / JP 行間 */
      --after-label-gap: 12px;
      --en-ja-gap: 6px;

      /* scroll (20% slower) */
      --speed-pps: 102;
      --gap-px: 80;
      --min-distance-px: 900;
      --update-interval-sec: 60;
    }

    *{ box-sizing:border-box; }

    html, body{
      width:1080px;
      height:70px;
      margin:0;
      padding:0;
      overflow:hidden;
      background:transparent;
    }

    .band{
      width:1080px;
      height:70px;
      display:flex;
      align-items:center;
      background:var(--band-bg);
      color:var(--text-color);
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
        "Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      overflow:hidden;
    }

    /* ===== LABEL (FULL HEIGHT) ===== */
    .label{
      height:70px;                 /* ← 常に70px */
      background:var(--label-bg);
      color:var(--label-color);
      font-weight:900;
      padding: 0 var(--label-pad-x);
      white-space:nowrap;
      user-select:none;
      flex-shrink:0;
      margin:0;

      display:grid;
      grid-template-rows: auto auto;
      align-content:center;        /* ← 上下中央寄せ */
      row-gap: var(--label-row-gap);
    }

    .label span{
      font-size: var(--label-font);
      line-height:1.2;             /* ← 視認性用 */
      display:flex;
      align-items:center;
    }

    /* ===== TEXT ===== */
    .textBlock{
      display:flex;
      flex-direction:column;
      justify-content:center;
      width:100%;
      overflow:hidden;
      margin-left: var(--after-label-gap);
      gap: var(--en-ja-gap);
    }

    .line{
      width:100%;
      overflow:hidden;
      position:relative;
    }

    .text{
      font-size: var(--text-font);
      font-weight:700;
      line-height:1.1;
      white-space:nowrap;
    }

    .scroller{
      display:inline-flex;
      will-change: transform;
    }

    .item{
      white-space:nowrap;
      padding-right:2ch;
    }

    .separator::after{
      content:" • ";
      opacity:.6;
    }

    @keyframes marquee{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(var(--distance, -1000px),0,0); }
    }

    .emergency .label{
      animation: blink 1s steps(2, jump-none) infinite;
      box-shadow: 0 0 .7em rgba(255,0,0,.7);
    }

    @keyframes blink{
      50%{ visibility:hidden; }
    }
  </style>
</head>

<body>
  <div class="band" id="band">
    <div class="label">
      <span>UPDATES</span>
      <span>最新情報</span>
    </div>

    <div class="textBlock">
      <div class="line en">
        <div class="scroller text" id="enText"></div>
      </div>
      <div class="line ja">
        <div class="scroller text" id="jaText"></div>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    const $ = s => document.querySelector(s);
    const enText = $("#enText");
    const jaText = $("#jaText");

    const params = new URLSearchParams(location.search);
    const facility = +(params.get("facility") || 379);
    const limit = Math.max(1, +(params.get("limit") || 10));
    const speed = +(params.get("speed") || 102);
    const gapPx = +(params.get("gap") || 80);
    const minDistance = +(params.get("mindist") || 900);
    const updSec = +(params.get("interval") || 60);

    const API = "https://web-api.yukiyama.biz/web-api/news/backward";

    async function fetchNews(lang){
      const url = new URL(API);
      url.searchParams.set("skiareaId", facility);
      url.searchParams.set("limit", limit);
      url.searchParams.set("lang", lang);
      const res = await fetch(url.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error(res.status);
      return Object.values(await res.json())
        .filter(v => v && (v.title || v.message))
        .sort((a,b)=> new Date(b.time)-new Date(a.time));
    }

    const compose = items =>
      items.map(v=>{
        const t=(v.title||"").trim();
        const m=(v.message||"").trim();
        return (t && m ? `${t} — ${m}` : (t||m))
          .replace(/\s+/g," ").trim();
      }).filter(Boolean);

    function renderLine(el, parts){
      el.innerHTML="";
      const make=()=>{
        const f=document.createDocumentFragment();
        parts.forEach((p,i)=>{
          const s=document.createElement("span");
          s.className="item"+(i<parts.length-1?" separator":"");
          s.textContent=p;
          f.appendChild(s);
        });
        return f;
      };
      el.appendChild(make());
      el.appendChild(make());
    }

    function measureWidth(el){
      const kids=[...el.children];
      const half=kids.length/2;
      let w=0;
      for(let i=0;i<half;i++) w+=kids[i].getBoundingClientRect().width;
      return w;
    }

    function setupSyncedMarquee(enEl, jaEl){
      const baseW = Math.max(measureWidth(enEl), measureWidth(jaEl));
      const travel = Math.max(baseW + gapPx, minDistance);
      const dist = -travel;
      const duration = Math.abs(dist) / speed;

      enEl.style.animation = "none";
      jaEl.style.animation = "none";
      void document.body.offsetWidth;

      enEl.style.setProperty("--distance", dist + "px");
      jaEl.style.setProperty("--distance", dist + "px");

      enEl.style.animation = `marquee ${duration}s linear infinite`;
      jaEl.style.animation = `marquee ${duration}s linear infinite`;
    }

    async function refresh(){
      const [en,ja]=await Promise.all([
        fetchNews("en").catch(()=>[]),
        fetchNews("ja").catch(()=>[])
      ]);
      renderLine(enText, compose(en.length?en:ja));
      renderLine(jaText, compose(ja.length?ja:en));
      requestAnimationFrame(()=>setupSyncedMarquee(enText, jaText));
    }

    refresh();
    setInterval(refresh, updSec*1000);
  })();
  </script>
</body>
</html>
