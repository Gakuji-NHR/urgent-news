<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1080, height=70, initial-scale=1" />
  <title>HANAZONO Updates Ticker</title>

  <style>
    :root{
      --band-bg: #000;
      --text-color: #fff;
      --label-bg: #c40000;
      --label-color: #fff;

      /* tuned for fixed 1080 x 70 */
      --label-font: 13px;
      --text-font: 17px;

      --label-pad-x: 12px;
      --label-pad-y: 4px;

      --after-label-gap: 12px;
      --en-ja-gap: 6px;

      /* scroll (15% slower) */
      --speed-pps: 127.5;
      --update-interval-sec: 60;

      /* loop spacing */
      --gap-px: 80;

      /* for short text: ensure the loop still feels like a ticker */
      --min-distance-px: 900;
    }

    *{ box-sizing:border-box; }

    html, body{
      width:1080px;
      height:70px;
      margin:0;
      padding:0;
      overflow:hidden;
      background:transparent;
    }

    .band{
      width:1080px;
      height:70px;
      display:flex;
      align-items:center;
      background:var(--band-bg);
      color:var(--text-color);
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
        "Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      overflow:hidden;
    }

    /* ===== LABEL ===== */
    .label{
      background:var(--label-bg);
      color:var(--label-color);
      font-weight:900;
      padding: var(--label-pad-y) var(--label-pad-x);
      white-space:nowrap;
      user-select:none;
      flex-shrink:0;
      margin:0;

      display:grid;
      grid-template-rows: 1fr 1fr;
      align-items:center;
    }

    .label span{
      font-size: var(--label-font);
      line-height:1;
      display:flex;
      align-items:center;
    }

    /* ===== TEXT ===== */
    .textBlock{
      display:flex;
      flex-direction:column;
      justify-content:center;
      width:100%;
      overflow:hidden;
      margin-left: var(--after-label-gap);
      gap: var(--en-ja-gap);
    }

    .line{
      width:100%;
      overflow:hidden;
      position:relative;
    }

    .text{
      font-size: var(--text-font);
      font-weight:700;
      line-height:1.1;
      white-space:nowrap;
    }

    .scroller{
      display:inline-flex;
      will-change: transform;
    }

    .item{
      white-space:nowrap;
      padding-right:2ch;
    }

    .separator::after{
      content:" • ";
      opacity:.6;
    }

    @keyframes marquee{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(var(--distance, -1000px),0,0); }
    }

    .emergency .label{
      animation: blink 1s steps(2, jump-none) infinite;
      box-shadow: 0 0 .7em rgba(255,0,0,.7);
    }

    @keyframes blink{
      50%{ visibility:hidden; }
    }
  </style>
</head>

<body>
  <div class="band" id="band">
    <div class="label">
      <span>UPDATES</span>
      <span>最新情報</span>
    </div>

    <div class="textBlock">
      <div class="line en">
        <div class="scroller text" id="enText"></div>
      </div>
      <div class="line ja">
        <div class="scroller text" id="jaText"></div>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    const $ = s => document.querySelector(s);
    const band = $("#band");
    const enText = $("#enText");
    const jaText = $("#jaText");

    const params = new URLSearchParams(location.search);
    const facility = +(params.get("facility") || 379);
    const limit = Math.max(1, +(params.get("limit") || 10));

    const speed = +(params.get("speed") || 127.5);         // px/sec
    const gapPx = +(params.get("gap") || 80);              // spacing between loops
    const updSec = +(params.get("interval") || 60);        // refresh interval
    const minDistance = +(params.get("mindist") || 900);   // ensure movement even for short text

    const emergency = ["1","true","on","yes"]
      .includes(String(params.get("emergency")).toLowerCase());
    if (emergency) band.classList.add("emergency");

    const API = "https://web-api.yukiyama.biz/web-api/news/backward";

    async function fetchNews(lang){
      const url = new URL(API);
      url.searchParams.set("skiareaId", facility);
      url.searchParams.set("limit", limit);
      url.searchParams.set("lang", lang);
      const res = await fetch(url.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error(res.status);
      return Object.values(await res.json())
        .filter(v => v && (v.title || v.message))
        .sort((a,b)=> new Date(b.time)-new Date(a.time));
    }

    const compose = items =>
      items.map(v=>{
        const t=(v.title||"").trim();
        const m=(v.message||"").trim();
        return (t && m ? `${t} — ${m}` : (t||m))
          .replace(/\s+/g," ").trim();
      }).filter(Boolean);

    function renderLine(el, parts){
      el.innerHTML="";
      const make=()=>{
        const f=document.createDocumentFragment();
        parts.forEach((p,i)=>{
          const s=document.createElement("span");
          s.className="item"+(i<parts.length-1?" separator":"");
          s.textContent=p;
          f.appendChild(s);
        });
        return f;
      };
      el.appendChild(make());
      el.appendChild(make());
    }

    function setupMarqueeAlways(el){
      const wrap = el.parentElement;
      const kids = [...el.children];
      const half = kids.length / 2;

      // measure width of one set
      let contentWidth = 0;
      for(let i=0;i<half;i++){
        contentWidth += kids[i].getBoundingClientRect().width;
      }

      // Always scroll:
      // If text is short, force a minimum travel distance so it still looks like a ticker.
      const travel = Math.max(contentWidth + gapPx, minDistance);

      // Move left by travel px, then loop
      const dist = -travel;
      el.style.setProperty("--distance", dist + "px");

      // restart animation cleanly
      el.style.animation = "none";
      void el.offsetWidth;

      // duration = distance / speed
      const duration = Math.abs(dist) / speed;
      el.style.animation = `marquee ${duration}s linear infinite`;
    }

    async function refresh(){
      try{
        const [en,ja]=await Promise.all([
          fetchNews("en").catch(()=>[]),
          fetchNews("ja").catch(()=>[])
        ]);
        renderLine(enText, compose(en.length?en:ja));
        renderLine(jaText, compose(ja.length?ja:en));

        requestAnimationFrame(()=>{
          setupMarqueeAlways(enText);
          setupMarqueeAlways(jaText);
        });
      }catch{
        renderLine(enText,["No updates available"]);
        renderLine(jaText,["現在、お知らせはありません"]);
        requestAnimationFrame(()=>{
          setupMarqueeAlways(enText);
          setupMarqueeAlways(jaText);
        });
      }
    }

    const ro = new ResizeObserver(()=>{
      setupMarqueeAlways(enText);
      setupMarqueeAlways(jaText);
    });
    ro.observe(band);

    refresh();
    setInterval(refresh, updSec*1000);
  })();
  </script>
</body>
</html>
